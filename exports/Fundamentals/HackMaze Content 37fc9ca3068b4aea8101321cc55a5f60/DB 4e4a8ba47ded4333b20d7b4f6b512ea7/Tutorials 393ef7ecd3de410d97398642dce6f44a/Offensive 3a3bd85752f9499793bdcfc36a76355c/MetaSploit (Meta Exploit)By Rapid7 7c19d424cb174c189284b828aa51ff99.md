# MetaSploit (Meta Exploit)By Rapid7

# msfvenom

### **`msfvenom -p Payload [options]`**

### `msfvenom -p payload --list-options`  or `--payload-options`

### **`msfvenom --list=formats` or `msfvenom --list formats` or `msfvenom -l formats`**

### Formats:

- Linux Executable and Linkable Format (elf)
    - The .elf format is comparable to the .exe format in Windows. These are executable files for Linux. However, you may still need to make sure they have executable permissions on the target machine.
- Windows `-f exe`  or `-f exe-service`
- PHP or Python `-f raw`
- ASP `-f asp`

<aside>
üî• options

- -p payload
- -o OutputFileName
- -f Format
- -e /encoder/path
- LHOST=IP
- LPORT=PORT
</aside>

- Staged VS Stageless Payload
    
    ![Untitled](MetaSploit%20(Meta%20Exploit)By%20Rapid7%207c19d424cb174c189284b828aa51ff99/Untitled.png)
    
    - ***Staged***¬†payloads are sent in two parts. The first part is called the¬†*stager*. This is a piece of code which is executed directly on the server itself. It connects back to a waiting listener, but doesn't actually contain any reverse shell code by itself. Instead it connects to the listener and uses the connection to load the real payload, executing it directly and preventing it from touching the disk where it could be caught by traditional anti-virus solutions. Thus the payload is split into two parts -- a small initial stager, then the bulkier reverse shell code which is downloaded when the stager is activated. Staged payloads require a special listener -- usually the Metasploit multi/handler, which will be covered in the next task.
    - ***Stageless***¬†payloads are more common -- these are what we've been using up until now. They are entirely self-contained in that there is one piece of code which, when executed, sends a shell back immediately to the waiting listener.
- Payload Name format
    
    ### `OSType/arch/payload`        
    `linux/x86/shell_reverse_tcp`
    
    - The exception to this convention is Windows 32bit targets. For these, the arch is not specified. e.g.:
        
        ### `windows/shell_reverse_tcp`
        

# **Meterpreter**

- info
    - `Whatis meterpreter`
        - Meterpreter is a Metasploit payload that supports the penetration testing process with many valuable components. Meterpreter will run on the target system and act as an agent within a command and control architecture. You will interact with the target operating system and files and use Meterpreter's specialized commands.
    - Detection
        - Meterpreter runs on the target system but is not installed on it. It runs in memory and does not write itself to the disk on the target. This feature aims to avoid being detected during antivirus scans. By default, most antivirus software will scan new files on the disk (e.g. when you download a file from the internet) Meterpreter runs in memory (RAM - Random Access Memory) to avoid having a file that has to be written to the disk on the target system (e.g. meterpreter.exe). This way, Meterpreter will be seen as a process and not have a file on the target system.
    - IPS, IDS
        - Meterpreter also aims to avoid being detected by network-based IPS (Intrusion Prevention System) and IDS (Intrusion Detection System) solutions by using encrypted communication with the server where Metasploit runs (typically your attacking machine). If the target organization does not decrypt and inspect encrypted traffic (e.g. HTTPS) coming to and  going out of the local network, IPS and IDS solutions will not be able to detect its activities. While Meterpreter is recognized by major antivirus software, this feature provides some degree of stealth.
- Meterpreter will provide you with three primary categories of tools;
    - Built-in commands
    - Meterpreter tools
    - Meterpreter scripting

Every version of Meterpreter will have different command options, so running the `help`¬†command is always a good idea. Commands are built-in tools available on Meterpreter. They will run on the target system without loading any additional script or executable files.

- If you run the `help`¬†command, you will see Meterpreter commands are listed under different categories.
    - Core commands
    - File system commands
    - Networking commands
    - System commands
    - User interface commands
    - Webcam commands
    - Audio output commands
    - Elevate commands
    - Password database commands
    - Timestomp commands

## Commands

- Core commands
    - `background`: Backgrounds the current session
    - `exit`: Terminate the Meterpreter session
    - `guid`: Get the session GUID (Globally Unique Identifier)
    - `help`: Displays the help menu
    - `info`: Displays information about a Post module
    - `irb`: Opens an interactive Ruby shell on the current session
    - `load`: Loads one or more Meterpreter extensions
    - `migrate`: Allows you to migrate Meterpreter to another process
    - `run`: Executes a Meterpreter script or Post module
    - `sessions`: Quickly switch to another session
- File system  commands
    - `cd`: Will change directory
    - `ls`: Will list files in the current directory (dir will also work)
    - `pwd`: Prints the current working directory
    - `edit`: will allow you to edit a file
    - `cat`: Will show the contents of a file to the screen
    - `rm`: Will delete the specified file
    - `search`: Will search for files
    - `upload`: Will upload a file or directory
    - `download`: Will download a file or directory
- Networking commands
    - `arp`: Displays the host ARP (Address Resolution Protocol) cache
    - `ifconfig`: Displays network interfaces available on the target system
    - `netstat`: Displays the network connections
    - `portfwd`: Forwards a local port to a remote service
    - `route`: Allows you to view and modify the routing table
- System commands
    - `clearev`: Clears the event logs
    - `execute`: Executes a command
    - `getpid`: Shows the current process identifier
    - `getuid`: Shows the user that Meterpreter is running as
    - `kill`: Terminates a process
    - `pkill`: Terminates processes by name
    - `ps`: Lists running processes
    - `reboot`: Reboots the remote computer
    - `shell`: Drops into a system command shell
    - `shutdown`: Shuts down the remote computer
    - `sysinfo`: Gets information about the remote system, such as OS
- Others Commands (these will be listed under different menu categories in the help menu)
    - `idletime`: Returns the number of seconds the remote user has been idle
    - `keyscan_dump`: Dumps the keystroke buffer
    - `keyscan_start`: Starts capturing keystrokes
    - `keyscan_stop`: Stops capturing keystrokes
    - `screenshare`: Allows you to watch the remote user's desktop in real time
    - `screenshot`: Grabs a screenshot of the interactive desktop
    - `record_mic`: Records audio from the default microphone for X seconds
    - `webcam_chat`: Starts a video chat
    - `webcam_list`: Lists webcams
    - `webcam_snap`: Takes a snapshot from the specified webcam
    - `webcam_stream`: Plays a video stream from the specified webcam
    - `getsystem`: Attempts to elevate your privilege to that of local system
    - `hashdump`: Dumps the contents of the SAM database
- **Migrate**
    - Migrating to another process will help Meterpreter interact with it. For example, if you see a word processor running on the target (e.g. word.exe, notepad.exe, etc.), you can migrate to it and start capturing keystrokes sent by the user to this process. Some Meterpreter versions will offer you the keyscan_start ,keyscan_stop, and keyscan_dump command options to make Meterpreter act like a keylogger. Migrating to another process may also help you to have a more stable Meterpreter session.
- `search -f flag2.txt`
- you can also use the load command to leverage additional tools such as Kiwi or even the whole Python language

## meterpreter do some handling so if you are exploiting windows when you type a path type `\\` or `/` don‚Äôt type `\` only

---

- **`/usr/share/doc/metasploit-framework/modules`**

exploit rating: [https://github.com/rapid7/metasploit-framework/wiki/Exploit-Ranking](https://github.com/rapid7/metasploit-framework/wiki/Exploit-Ranking)

`<type>/<os>/<service>/<name>`
`exploit/windows/ftp/scriptftp_list`

<aside>
üëª **run**

### **`sudo systemctl start postgresql.service`**

### **`sudo systemctl enable postgresql.service`**

### **`sudo msfdb init && msfconsole`**

### **update : `sudo apt update && sudo apt install metasploit-framework`   or `msfupdate`**

</aside>

---

<aside>
‚ÑπÔ∏è **information**

### **`info module_name`  show everything about <module> info = show options + additional information**

### **`show options`**

---

### **`> workspace   # show the existed workspaces`**

### **`> workspace -a <name>` add a workspace**

### **`> workspace <name>` switch to the workspace**

### **`> workspace -d <name>`delete the workspace**

### **`> workspace -D` delete all the workspaces**

### **`> workspace -r <old> <new>`**

</aside>

---

<aside>
üîç **Search**

### **`search type:module name:<name>` ‚áí type:exploit or auxiliary**

</aside>

---

<aside>
üõ°Ô∏è **Core Commands**

<aside>
üí° **Before starting Metasploit, we can view some of the advanced options we can trigger for starting the console. Check these out now by using the command:**

### **`msfconsole -h`**

</aside>

<aside>
üí° **Show All commands and help page**

### **`help <Command Type>`**

### **`?`**

</aside>

<aside>
üí° **use the previous module**

### **`previous`**

</aside>

<aside>
üí° **Get the value of specific variable**

### **`get RHOSTS`**

</aside>

<aside>
üí° **Show information about specific module**

### **`info ModuleName`**

- **Info will show more details than `show options`**
</aside>

<aside>
üí° **set variable using a file**

### **`set RHOSTS /path/to/file.txt`**

</aside>

<aside>
üí° **Set a global variable**

### **`setg RHOSTS 192.168.1.10`**

</aside>

<aside>
üí° **set the value of a variable to NULL**

### **`unset LPORT
unsetg RHOSTS`**

</aside>

<aside>
üí° **save the output to a specific file**

### **`spool /home/juba/MetasploitOutput`**

</aside>

<aside>
üí° **Saves the active data stores (all you did variable value, output, search, anything)**

### **`save`**

</aside>

<aside>
üí° **Connect to a host on specific port (similar to `Netcat`)**

### **`connect 127.0.0.1 4040`**

</aside>

</aside>

---

<aside>
üí° **After Metasploit has started, let's go ahead and check that we've connected to the database. Do this now with the command:**

### **`db_status`**

</aside>

---

<aside>
üí°

- **Metasploit modules**
    - **exploit**
    - **auxiliary**
    - **post**
    - **payload**
    - **encoder: Commonly utilized in payload obfuscation,  allows us to modify the 'appearance' of our exploit such that we may avoid signature detection?**
    - **nop**
    - **evasion**
    
    ![Untitled](MetaSploit%20(Meta%20Exploit)By%20Rapid7%207c19d424cb174c189284b828aa51ff99/Untitled%201.png)
    
- **Not every module is loaded in by default, what command can we use to load different modules?**
    
    ### **`load`**
    
    ### **`load powershell 
    powershell_shell` to start the powershell**
    
- **Metasploit does support different types of port scans from within the auxiliary modules.¬†Metasploit can also import other scans from nmap and Nessus just to name a few.**
- **you can use nmap inside metasploit**
    
    ### **`db_nmap [OPTIONS] RHOSTS`**
    
    - db_nmap will save nmap result to the database
    
    ### **`nmap [OPTIONS] RHOSTS`**
    
- **After running db_nmap, be sure to check out the result of hosts and services**
- **After scanning with nmap the output will be saved in the database**
</aside>

---

## **Database Back-end Commands**

<aside>
üõ°Ô∏è **List all hosts in the database**

### **`hosts`**

### **`hosts -h`**

</aside>

<aside>
üí° set RHOSTS from the results of the search (hosts in db)

### **`hosts -R`**

</aside>

<aside>
üõ°Ô∏è **list all the services in the database**

### **`services`**

### **`services -h`**

</aside>

<aside>
üí° Search for a service

### **`services -S`**

</aside>

<aside>
üõ°Ô∏è **list all the vulnerabilities in the database**

### **`vulns`**

</aside>

---

<aside>
üí° Important note about search

### **`search type: auxiliary <search key>`**

</aside>

<aside>
üõ°Ô∏è **Important note about use**

**you can Type** 

### **`use Num_Next_To_module`  or `use /path/to/exploit`  or `use num /path/to/exploit`**

![Untitled](MetaSploit%20(Meta%20Exploit)By%20Rapid7%207c19d424cb174c189284b828aa51ff99/Untitled%202.png)

</aside>

<aside>
üõ°Ô∏è **Exploit**

### **`run -j`    or    `exploit -z`**

<aside>
üõ°Ô∏è **list all running jobs**

### **`jobs`**

</aside>

</aside>

```bash
msf6 auxiliary(scanner/portscan/tcp) > set RHOSTS 192.168.147.132
msf6 auxiliary(scanner/portscan/tcp) > run 
msf6 auxiliary(scanner/portscan/tcp) > ***services*** # to show the result 
====================================================================================================================
msf6 auxiliary(scanner/portscan/tcp) > db_nmap -n name_the_target 192.168.147.132 -A -Pn # use nmap inside metasploit framework
```

<aside>
üõ°Ô∏è **list all the sessions**

### **`sessions`**

</aside>

<aside>
üõ°Ô∏è **Select a session**

### **`sessions -i <session_nubmer>`**

</aside>

---

<aside>
üõ°Ô∏è **If you got a reverse shell (not meterpreter)**

### **`search shell_to_meterpreter`**

### **`use post/multi/manage/shell_to_meterpreter`**

</aside>

---

## **After getting `meterpreter` shell**

<aside>
üõ°Ô∏è **transfer the process on which the exploit is running on a different process**

### **`migrate -N ServiceName`**

### **`migrate -P PID`**

</aside>

<aside>
üõ°Ô∏è **get the user-id**

### **`getuid`**

</aside>

<aside>
üõ°Ô∏è **get system information**

### **`sysinfo`**

</aside>

<aside>
üõ°Ô∏è **use the new version of mimikatz see [this](https://www.notion.so/c801d83a575c46ba890495384b02221b?pvs=21) and [this](https://www.notion.so/0b7e4184f6114c3fb97fbca0b1dc4b8a?pvs=21) and [this](https://www.notion.so/a97d55ef55ad4918adb4b5e492792cc8?pvs=21) to know what is mimikatz or kiwi**

### **`load kiwi`**

</aside>

<aside>
üõ°Ô∏è **Attempt to enable all privileges available to the current process**

### **`getprivs`**

</aside>

<aside>
üõ°Ô∏è **Executes a meterpreter script or Post module**

### **`run /path/to/script`**

</aside>

<aside>
üõ°Ô∏è **Check if the target is a Virtual Machine**

### **`run post/windows/gather/checkvm`**

</aside>

<aside>
üõ°Ô∏è **Drop into a system command shell (use the system shell like CMD)**

### **`shell`**

</aside>

---

## **Pivoting**

<aside>
üõ°Ô∏è **add a new route**

### **`meterpreter> run autoroute -h`**

### **`meterpreter> run autoroute -s IPaddress/24` or use `-s IP -N mask`**

</aside>

<aside>
üõ°Ô∏è **Setup Socks Proxy**

- **SockS Proxy: Socket Secure Proxy**

### **`run auxiliary/server/socks5`**

- **edit /etc/proxychains.config and include the new server**

[ProxyTunnels | Offensive Security](https://www.offensive-security.com/metasploit-unleashed/proxytunnels/)

</aside>

---

- **Now, we will use multi/handler, which is¬†a stub that handles exploits launched outside of the framework.You can start a handler with Metasploit at any time, this is useful when you are executing a backdoor in a victim's machine and you need to connect back to take control. ... The Listening IP and Port must match the ones of your Backtrack or the machine**

---

<aside>
üí° **Payload Types**

### **INLINE or single (NON STAGED/Stageless)**

- **A single payload containing the exploit and full shell code for the selected task. Inline payloads are by design more stable than their counterparts because they contain everything all in one. However some exploits wont support the resulting size of these payloads.**

### **STAGER**

- **Stager payloads work in conjunction with stage payloads in order to perform a specific task. A stager establishes a communication channel between the attacker and the victim and reads in a stage payload to execute on the remote host.**
- **Stages:**¬†Downloaded by the stager. This will allow you to use larger-sized payloads.

![Untitled](MetaSploit%20(Meta%20Exploit)By%20Rapid7%207c19d424cb174c189284b828aa51ff99/Untitled.png)

</aside>

---

# Help

# Core Commands

```
Command       Description
-------       -----------
?             Help menu
banner        Display an awesome metasploit banner
cd            Change the current working directory
color         Toggle color
connect       Communicate with a host
debug         Display information useful for debugging
exit          Exit the console
features      Display the list of not yet released features that can be opted in to
get           Gets the value of a context-specific variable
getg          Gets the value of a global variable
grep          Grep the output of another command
help          Help menu
history       Show command history
load          Load a framework plugin
quit          Exit the console
repeat        Repeat a list of commands
route         Route traffic through a session
save          Saves the active datastores
sessions      Dump session listings and display information about sessions
set           Sets a context-specific variable to a value
setg          Sets a global variable to a value
sleep         Do nothing for the specified number of seconds
spool         Write console output into a file as well the screen
threads       View and manipulate background threads
tips          Show a list of useful productivity tips
unload        Unload a framework plugin
unset         Unsets one or more context-specific variables
unsetg        Unsets one or more global variables
version       Show the framework and console library version numbers
```

# Module Commands

```
Command       Description
-------       -----------
advanced      Displays advanced options for one or more modules
back          Move back from the current context
clearm        Clear the module stack
favorite      Add module(s) to the list of favorite modules
info          Displays information about one or more modules
listm         List the module stack
loadpath      Searches for and loads modules from a path
options       Displays global options or for one or more modules
popm          Pops the latest module off the stack and makes it active
previous      Sets the previously loaded module as the current module
pushm         Pushes the active or list of modules onto the module stack
reload_all    Reloads all modules from all defined module paths
search        Searches module names and descriptions
show          Displays modules of a given type, or all modules
use           Interact with a module by name or search term/index

```

# Job Commands

```
Command       Description
-------       -----------
handler       Start a payload handler as job
jobs          Displays and manages jobs
kill          Kill a job
rename_job    Rename a job

```

# Resource Script Commands

```
Command       Description
-------       -----------
makerc        Save commands entered since start to a file
resource      Run the commands stored in a file

```

# Database Backend Commands

```
Command           Description
-------           -----------
analyze           Analyze database information about a specific address or address range
db_connect        Connect to an existing data service
db_disconnect     Disconnect from the current data service
db_export         Export a file containing the contents of the database
db_import         Import a scan result file (filetype will be auto-detected)
db_nmap           Executes nmap and records the output automatically
db_rebuild_cache  Rebuilds the database-stored module cache (deprecated)
db_remove         Remove the saved data service entry
db_save           Save the current data service connection as the default to reconnect on startup
db_status         Show the current data service status
hosts             List all hosts in the database
loot              List all loot in the database
notes             List all notes in the database
services          List all services in the database
vulns             List all vulnerabilities in the database
workspace         Switch between database workspaces

```

# Credentials Backend Commands

```
Command       Description
-------       -----------
creds         List all credentials in the database

```

# Developer Commands

```
Command       Description
-------       -----------
edit          Edit the current module or a file with the preferred editor
irb           Open an interactive Ruby shell in the current context
log           Display framework.log paged to the end if possible
pry           Open the Pry debugger on the current module or Framework
reload_lib    Reload Ruby library files from specified paths
time          Time how long it takes to run a particular command

```

![Untitled](MetaSploit%20(Meta%20Exploit)By%20Rapid7%207c19d424cb174c189284b828aa51ff99/Untitled%203.png)